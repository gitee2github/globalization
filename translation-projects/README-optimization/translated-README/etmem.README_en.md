# Etmem

## Introduction

The development of CPU computing power - particularly lower costs of ARM cores - makes memory cost and capacity the core frustration, limiting business cost and performance. Therefore, the most pressing issue is how to save memory cost and how to expand memory capacity. 

Etmem is a memory vertical expansion technology that can achieve the purpose of memory capacity expansion and memory cost reduction. To do so, it first needs to hierarchize memory data based on hierarchical memory storage generated by DRAM+memory compression/new high-performance storage media, and then moves hierarchized memory cold data from memory media to high-performance storage media.  

## Compiling tutorial

1. Download etmem source code

    $ git clone https://gitee.com/openeuler/etmem.git

2. Compile- and run-time dependencies

    the compiling and running of etmem depend on libboundscheck modules

3. Compiling

    $ cd etmem

    $ mkdir build

    $ cd build

    $ cmake ..

    $ make


## Instructions

### Start etmemd

#### Usage 

Run the server by executing binary files of etmemd :

$ etmemd -l 0 -s etmemd_socket

#### Help information

options：

-l|\-\-log-level <log-level>  Log level

-s|\-\-socket <sockect name>  Socket name to listen to

-h|\-\-help  Show this message

-m|\-\-mode-systemctl mode used to start(systemctl)

#### Command-line option descriptions

| Options | Explanation | Required | Parameters | Range | Examples                                            |
| ---------------------- | ------------------------------------------------------------ | -------- | ---------- | --------------------- | ------------------------------------------------------------ |
| -l or \-\-log-level  | Etmemd log level                                              | No     | Yes         | 0~3                   | 0：debug level  1：info level  2：warning level 3：error level   Only levels more than or equal to the configured level can be printed into /var/log/message |
| -s or \-\-socket     | The name monitored by etmemd,  used to interface with clients | Yes       | Yes         | A string less than 107 characters | Assign names monitored by the server |
| -h or \-\-help       | Help information                                            | No       | No         | NA                    | Execution with this option will print and exit |
| -m or \-\-mode-systemctl | This option can be used to support the starting of fork mode as etmemd is pulled as service | No     | No         | NA                    | NA                                                           |
| ### etmem configuration files |                                                              |          |            |                       |                                                              |

Before running etmem, the administer  should plan which process's memory needs to be expanded, and prepare the configuration file, including process information like memory scanning cycles, scanning times and the threshold of hot and cold memory. 

The example of the configuration file is contained in source code package which lies in root directory of the source code - conf/example_conf.yaml. We suggest that it should be put under directory - /etc/etmem/. The following is an example：

```
[project]
name=test
loop=1
interval=1
sleep=1

#slide engine example
[engine]
name=slide
project=test

[task]
project=test
engine=slide
name=background_slide
type=name
value=mysql
T=1
max_threads=1

#cslide	engine example
[engine]
name=cslide
project=test
node_pair=2,0;3,1
hot_threshold=1
node_mig_quota=1024
node_hot_reserve=1024

[task]
project=test
engine=cslide
name=background_cslide
type=pid
name=23456
vm_flags=ht
anon_only=no
ign_host=no

#thirdparty engine example
[engine]
name=thirdparty
project=test
eng_name=my_engine
libname=/usr/lib/etmem_fetch/my_engine.so
ops_name=my_engine_ops
engine_private_key=engine_private_value

[task]
project=test
engine=my_engine
name=backgroud_third
type=pid
value=12345
task_private_key=task_private_value
```

Descriptions of each field in the configuration file：

| Configuration items | Explanation | Required                       | Parameters | Range | Examples                                                     |
| ------------------ | :----------------------------------------------------------- | ------------------------------ | ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| [project]          | The start ID of the project common configuration section | No                             | No         | NA                                                           | The start ID of the project, indicating that the following parameters all belong to the project section  up to another [XXX] or the end of the file  project. |
| name               | The project name                    | Yes                            | Yes        | A string less than 64 characters                             | It is used to identify the project that mount engine and task during configuration |
| loop               | The number of memory scanning cycles                   | Yes                            | Yes        | 1~10                                                         | loop=3 //Scan 3 times.                                       |
| interval           | An interval between each scanning                            | Yes                            | Yes        | 1~1200                                                       | interval=5 //The interval between each scanning is 5s.      |
| sleep              | An interval between a longer cycle of memory scanning + operation | Yes                            | Yes        | 1~1200                                                       | sleep=10 //The interval between such longer cycle is 10s. |
| [engine]           | the start ID of the engine common configuration section | No                             | No         | NA                                                           | The start ID of the engine, indicating that the following parameters all belong to the engine section up to another [XXX] or the end of the file. |
| project            | Declare the project                                          | Yes                            | Yes        | A string less than 64 characters                             | If there is a project named as test, it could be written as project=test |
| engine             | Declare the engine                                           | Yes                            | Yes        | slide/cslide/thridparty                                      | Declare the used polices are slid, cslide or thirparty |
| node_pair          | A configuration item of the cslide engine declares node pair of AEP and DRAM | Yes, when engine is cslide     | Yes        | Configure the node of AEP and DRAM in pairs, with AEP and DRAM separated by comma and each pair separated by semicolon | node_pair=2,0;3,1                                            |
| hot_threshold      | A configuration item of the cslide engine declares the threshold of hot and cold memory | Yes, when engine is cslide     | Yes        | integer >= 0                                                 | hot_threshold=3 //Access times less than 3 will be identified as cold memory |
| node_mig_quota     | Traffic control, a configuration item of the cslide engine, declares the maximum one-way traffic each time DRAM and AEP move to each other | Yes, when engine is cslide     | Yes        | integer >= 0                                                 | node_mig_quota=1024 //With unit being MB, it costs 1024M maximally moving from AEP to DRAM or from DRAM to AEP |
| node_hot_reserve   | A configuration item of the cslide engine declares the reserved space of hot memory in DRAM | Yes, when engine is cslide     | Yes        | integer >= 0                                                 | node_hot_reserve=1024 //The unit is MB. If the hot memory of all VMs exceeds the value, they will be moved to AEP. |
| eng_name           | A configuration item of the thirdparty engine declares the name of engine itself for task to mount | Yes, when engine is thirdparty | Yes        | A string less than 64 characters                             | eng_name=my_engine //When the thirdparty engine mounts tasks, engine=my_engine should be written clearly in the task |
| libname            | A configuration item of the thirdparty engine declares the address -absolute address-of the thirdparty-policy dynamic library | Yes, when engine is thridparty | Yes        | A string less than 64 characters                             | libname=/user/lib/etmem_fetch/code_test/my_engine.so         |
| ops_name           | A configuration item of the thirdparty engine declares the name of operation symbols in the thirdparty-policy dynamic library | Yes, when engine is thirdparty | Yes        | A string less than 64 characters                             | ops_name=my_engine_ops //The name of the thirdparty struct that implements the interface |
| engine_private_key | A configuration item of the thirdparty engine is reserved for  the thirdparty policies to analyse private keys, optional | No                             | No         | Private keys are restricted according to the thirdparty policies | Private engine parameters are configured according to the thirdparty policies |
| [task]             | The start ID of the task common configuration section | No                             | No         | NA                                                           | The start ID of the task, indicating that the following parameters all belong to the task section up to another [XXX] or the end of the file. |
| project            | Declare the mounted project                                  | Yes                            | Yes        | A string less than 64 characters                             | If there is a project named as test, it could be written as  project=test |
| engine             | Declare the mounted engine                                   | Yes                            | Yes        | A string less than 64 characters                             | the name of the mounted engine                               |
| name               | The task name                                | Yes                            | Yes        | A string less than 64 characters                             | name=background1 //Declare that the name of task is backgound1 |
| type               | The method identified by  the targeted process           | Yes                            | Yes        | pid/name                                                     | pid means identification based on the process id; name means identification based on the process name |
| value              | the specific field identified by the targeted process      | Yes                            | Yes        | The real process ID/ process name                          | It should be used with type to assign process ID and name, and the correctness and uniqueness of its configuration should be ensured by users |
| T                  | A configuration item of task, when engine is slide, declares the threshold of hot and cold memory | Yes, when engine is slide      | Yes        | 0~loop * 3                                                   | T=3 //memory with access times less than 3 will be identified as cold memory |
| max_threads        | A configuration item of task, when engine is slide, means the maximum threads in etmemd thread pool. And each thread handles memory scanning of one process/subprocess, and operation task | No                             | Yes        | 1~2 * core + 1, with default being 1                         | With no external representation, it control the number of thread inside the etmemd server. When there are multiple subprocesses of the targeted process, the larger configuration leads to more concurrent executions, but more resources are occupied. |
| vm_flags           | A configuration item of task, when engine is cslide, is used to scan vma by assigning flags. Without this configuration item, the scanning will be indiscriminate | Yes, when engine is cslide     | Yes        | Only ht is supported at present                              | vm_flags=ht //The memory of vma whose flages are ht(huge page) will be scanned |
| anon_only          | A configuration item of task, when engine is cslide, identifies that only anonymous page needs to be scanned. | No                             | Yes        | yes/no                                                      | anon_only=no //If yes is given, only scan anonymous pages. If no, non-anonymous pages are also included |
| ign_host           | A configuration item of task, when engine is cslide, identifies whether to ignore the scanning information of page tables on host | No                             | Yes        | yes/no                                                      | ign_host=no //If yes, ignore. If no, not              |
| task_private_key   | A configuration item of task, when engine is thirdparty, is deserved for thirdparty tasks to analyse private keys, optional | No                             | No         | Private keys are restricted according to the thirdparty policies | Task private keys are configured according to the thirdparty policies |



### Create and delete etmem project/engine/task object

#### Scene description

1）Administer creates etmem project/engine/task(one project can contains multiple etmem engines, and each engine can contain multiple tasks.)

2）Administer delete existed etmem project/engine/task(before deleting a project, all tasks in the project will be stopped automatically)

#### Usage

By executing etmem's binary files and Assigning the second parameter as obj, users can create and delete actions. Project/engine/task can be identified and distinguished by its configuration file. These above are based on the premise of proper the configuration file and an ongoing process.

Add objects：

etmem obj add -f /etc/example_config.yaml -s etmemd_socket

Delete objects：

etmem obj del -f /etc/example_config.yaml -s etmemd_socket

Print help：

etmem obj help

#### Help information 

Usage:

etmem obj add [options]

etmem obj del [options]

etmem obj help

Options:

-f|\-\-file <conf_file> Add configuration file

-s|\-\-socket <socket_name> Socket name to connect

Notes:

1. The configuration file must be given.

#### Command-line option descriptions


| Options          | Explanation                                                  | Required                                  | Parameters | Examples                                                     |
| ---------------- | ------------------------------------------------------------ | ----------------------------------------- | ---------- | ------------------------------------------------------------ |
| -f or \-\-file   | Assign the configuration file of objects                     | The add，del subcommands must be included | Yes        | The name of the path needs to be assigned                    |
| -s or \-\-socket | The name of socket that communicates with the etmemd server should accord with that assigned at the beginning of etmemd | The add, del subcommands must be included | Yes        | It must be given. When there are several etmemds, it is administer that decides which one to communicate. |

### Start/stop/show etmem tasks

#### Scene description

If it is at the period between adding a project by the command: etmem obj add and deleting it by the command: etmem obj del, you can start and stop the etmem project.

1）The administer starts added projects

2）The administer stop started projects

If the project has already been started when obj del is called to delete it by the administer, it would be stopped automatically.

#### Usage

A project, which is successfully added, can be started and stopped by commands of etmem project. The followings are examples：

Start a project

etmem project start -n test -s etmemd_socket

Stop a project

etmem project stop -n test -s etmemd_socket

Show a project

etmem project show -n test -s etmemd_socket

Print help

etmem project help

#### Help information

Usage:

etmem project start [options]

etmem project stop [options]

etmem project show [options]

etmem project help

Options:

-n|\-\-name <proj_name> Add project name

-s|\-\-socket <socket_name> Socket name to connect

Notes:

1. The project name and the socket name must be given when execute add or del option.

2. The socket name must be given when execute show option.

#### Command-line option descriptions

| Options          | Explanation                                                  | Required                                           | Parameters | Examples                                                     |
| ---------------- | ------------------------------------------------------------ | -------------------------------------------------- | ---------- | ------------------------------------------------------------ |
| -n or \-\-name   | Assign the project name                                      | The start，stop，show subcommands must be included | Yes        | It's an one-to-one correspondence between names of projects and those in the configuration file. |
| -s or \-\-socket | The socket name that communicates with the server should accord with that assigned as etmemd started | The start，stop，show subcommands must be included | Yes        | It must be given. When there are several etmemds, administer decides which one to communicate. |

### Etmem supports automatic restart

#### Scene description

Etmemd allows users to fork the systemd configuration file and run it as a systemd service.

#### Usage

Compile the configuration file of service to start etmemd, but parameter -m must be assigned to this mode. For example:

etmemd -l 0 -s etmemd_socket -m

#### Help information

options:

-l|\-\-log-level <log-level> Log level

-s|\-\-socket <sockect name> Socket name to listen to

-m|\-\-mode-systemctl mode used to start(systemctl)

-h|\-\-help Show this message

#### Command-line option descriptions
| Options                  | Explanation                                                  | Required | Parameters | Range                             | Examples                                                     |
| ------------------------ | ------------------------------------------------------------ | -------- | ---------- | --------------------------------- | ------------------------------------------------------------ |
| -l or \-\-log-level      | etmemd log levels                                            | No       | Yes        | 0~3                               | 0：debug level；1：info level；2：warning level；3：error level；Only Levels more than or equal to the configuration level can be printed into /var/log/message |
| -s or \-\-socket         | The name monitored by etmemd,  used to interface with clients | Yes      | Yes        | A string less than 107 characters | Assign names monitored by the server                         |
| -m or \-\-mode-systemctl | This option can be used to support the starting of fork mode as etmemd is pulled up as service | No       | No         | NA                                | NA                                                           |
| -h or \-\-help           | Help information                                             | No       | No         | NA                                | Execution with this option will print and exit               |




### Etmem supports thirdparty memory expansion polices

#### Scene description

Etmem supports users to register thirdparty memory expansion policies, and also offers the dynamic library of scanning modules which can evict memory by thirdparty algorithms at run time.

Users can use the dynamic library of scanning modules provided by Etmem and interface with the struct required by etmem. 

#### Usage

If users use thirdparty expansion eviction policies implemented by themselves, they need to follow these steps:

1. Call the scanning interfaces provided by scanning modules as required.

2. Implement each interface according to function template in etmem header file, and finally encapsulate them to an struct

3. Compile a dynamic library of thirdparty expansion eviction policies

4. Declare the thirdparty engine in the configuration file as required 

5. Fill the names of dynamic libraries and the struct into fields corresponding to task in the configuration file

Other steps are similar to the way of using other etmem engines

Struct template

struct engine_ops {

/* If there is analysis on engine private keys, it needs to be implemented; if not, set NULL. */

int (*fill_eng_params)(GKeyFile *config, struct engine *eng);

/* If there is clearing of engine private keys, it needs to be implemented; if not, set NULL. */

void (*clear_eng_params)(struct engine *eng);

/* If there is analysis on task private keys, it needs to be implemented; if not, set NULL. */

int (*fill_task_params)(GKeyFile *config, struct task *task);

/* If there is clearing of task private keys, it needs to be implemented; if not, set NULL */

void (*clear_task_params)(struct task *tk);

/* Start task interface */

int (*start_task)(struct engine *eng, struct task *tk);

/* Stop task interface */

void (*stop_task)(struct engine *eng, struct task *tk);

/* Fill pid-related private keys */

int (*alloc_pid_params)(struct engine *eng, struct task_pid **tk_pid);

/* Destroy pid-related private keys */

void (*free_pid_params)(struct engine *eng, struct task_pid **tk_pid);

/* Private commands required by thirdparty policies as following, If not, set NULL. */

int (*eng_mgt_func)(struct engine *eng, struct task *tk, char *cmd, int fd);

};

The following is an example of the configuration file. See conf file in root directory for more details:

#thirdparty

[engine]

name=thirdparty

project=test

eng_name=my_engine

libname=/user/lib/etmem_fetch/code_test/my_engine.so

ops_name=my_engine_ops

engine_private_key=engine_private_value

[task]

project=test

engine=my_engine

name=background1

type=pid

value=1798245

task_private_key=task_private_value

 **Note** ：

Users can use the dynamic library of scanning modules provided by Etmem and implement the interface of the struct required by etmem.

0xff and 0xfe cannot be written into the interface - eng_mgt_func

Different dynamic libraries of thirdparty policies can be added into the same project and distinguished by eng_name in the configuration file.

### Etmem supports memory expansion by AEP

#### Scene description

Using the etmem kit enables memory to expand to AEP path.

The huge pages of VMs are scanned within the node, and cold memory is moved to AEP via eviction policies of sclide engine.

#### Usage

Use cslide engine to expand memory. The following is an example. See conf file in root directory for more details.

#cslide

[engine]

name=cslide

project=test

node_pair=2,0;3,1

hot_threshold=1

node_mig_quota=1024

node_hot_reserve=1024

[task]

project=test

engine=cslide

name=background1

type=pid

value=1823197

vm_flags=ht

anon_only=no

ign_host=no

 **Notes** ：Do not concurrently scan the same process

Meanwhile, this cslide policy supports private commands


- showtaskpages
- showhostpages

For engine used this policy and all tasks of the engine, this two orders can be used to show access history of task pages and the using history of the system pages on the host of the VM. 

The following is an example：

etmem engine showtaskpages <-t task_name> -n proj_name -e cslide -s etmemd_socket

etmem engine showhostpages -n proj_name -e cslide -s etmemd_socket

 **Note** ：showtaskpages and showhostpages only support cslide engine

#### Command-line parameters description
| Options             | Explanation                                                  | Required | Parameters | Examples                                                     |
| ------------------- | ------------------------------------------------------------ | -------- | ---------- | ------------------------------------------------------------ |
| -n or \-\-proj_name | Assign the project name                                      | Yes      | Yes        | Assign projects that are already existed and need to be executed |
| -s or \-\-socket    | The name of socket that communicates with the etmemd server should accord with that assigned as etmemd started | Yes      | Yes        | It must given. When there are several etmemds, it is administer that decides which one to communicate. |
| -e or \-\-engine    | Assign the name of the executing engine                      | Yes      | Yes        | Assign the name of the engine that are already existed and need to be executed |
| -t or \-\-task_name | Assign the name of the executing task                        | No       | Yes        | Assign the name of the task that is already existed and need to be executed |

## Contribution

1.  Fork the repository
2.  Create a branch
3.  Commit your changes
4.  Create Pull Request